# Vite Configuration Notes

## CRITICAL: Production Build Settings

### ⚠️ NEVER USE THESE IN PRODUCTION:
```javascript
// WRONG - Causes jsxDEV errors
react({
  jsxRuntime: 'classic',  // ❌ WRONG for production
  jsxDev: true,           // ❌ MUST be false
  fastRefresh: true,      // ❌ Development only
})
```

### ✅ CORRECT PRODUCTION CONFIG:
```javascript
react({
  jsxRuntime: 'automatic',  // ✅ Correct for production
  jsxImportSource: 'react',
  jsxDev: false,            // ✅ MUST be false
  fastRefresh: false,       // ✅ Disabled for production
})
```

## Build Issues Caused by Wrong Config

1. **`e.jsxDEV is not a function`**
   - Cause: Using development JSX transform in production
   - Fix: Set `jsxDev: false` and `jsxRuntime: 'automatic'`

2. **Blank popup with no errors**
   - Cause: HTML opacity set to 0 without theme loader working
   - Fix: Set body opacity to 1 in popup.html

3. **Module not found errors**
   - Cause: Wrong import paths after build
   - Fix: Ensure rollupOptions output paths are correct

## Clean Production Config (vite.config.clean.ts)

This is the WORKING production config - use this if build breaks:

```javascript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react-swc';
import { resolve } from 'path';
import { fileURLToPath, URL } from 'node:url';

export default defineConfig({
  mode: 'production',
  base: './',
  
  define: {
    'process.env.NODE_ENV': JSON.stringify('production'),
    'import.meta.env.MODE': JSON.stringify('production'),
    'import.meta.env.DEV': JSON.stringify(false),
    'import.meta.env.PROD': JSON.stringify(true),
  },
  
  plugins: [
    react({
      jsxRuntime: 'automatic',
      jsxImportSource: 'react',
      jsxDev: false,
      fastRefresh: false,
    }),
  ],
  
  esbuild: {
    jsx: 'automatic',
    jsxFactory: 'React.createElement',
    jsxFragment: 'React.Fragment',
    minify: true,
    drop: ['console', 'debugger'],
  },
  
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
      },
    },
    sourcemap: false,
    outDir: 'dist',
    emptyOutDir: true,
    rollupOptions: {
      input: {
        popup: resolve(__dirname, 'src/popup/index.html'),
        options: resolve(__dirname, 'src/options/index.html'),
        background: resolve(__dirname, 'src/background/service-worker.ts'),
        content: resolve(__dirname, 'src/content/content.ts'),
      },
      output: {
        entryFileNames: '[name].js',
        chunkFileNames: 'assets/[name].[hash].js',
        assetFileNames: 'assets/[name].[ext]',
      },
    },
    target: 'chrome90',
  },
  
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
    },
  },
});
```

## Build Command Issues

If seeing "2" appended to paths:
- Use full yarn path: `/home/ahsan/.local/share/pnpm/yarn build`
- Or use npx: `npx vite build`
- Check for shell aliases affecting yarn

## Emergency Recovery

If build is completely broken:
```bash
# 1. Restore clean config
cp vite.config.clean.ts vite.config.ts

# 2. Clean build
rm -rf dist
yarn build

# 3. Fix popup.html
sed -i 's/opacity: 0/opacity: 1/g' dist/popup.html

# 4. Verify
grep "popup.js" dist/popup.html
```

## DO NOT FORGET

1. **Always test popup after build** - Click extension icon
2. **Check console for errors** - Open DevTools on popup
3. **Verify CSS loaded** - UI should be styled
4. **Keep vite.config.clean.ts** - As backup